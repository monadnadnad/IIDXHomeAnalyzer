# IIDX Home Analyzer
![dash_date_demo](https://user-images.githubusercontent.com/55864383/211237184-3b13625c-cc0e-403d-aab3-7bd6e2a4fd12.gif)
このリポジトリはBeatmania IIDXの店舗内のプレイ状況を分析するためのアプリケーションです。
プレイ人数の記録を取ることで、曜日や時間帯ごとの混雑状況を大まかに把握することができます。

大人気ゲームIIDXでは数十分待ちが珍しくなく、プレイの度に手が冷えて上達に支障がでます。
連コできる時間を探して、この問題に対処するためにこのアプリケーションを作成しています。
ライバル検索機能を使用するため、ベーシックコース以上の加入が必要です。

## 機能
- 最終プレイ店舗のプレイ履歴の取得とログへの記録
- ログからのデータ構築・グラフ化
    - その日のプレイ人数の推移
    - 曜日ごとの平均プレイ人数推移

機械学習などを利用した混雑予測等は行いません。

## インストール
実行にはPython 3.10以上が必要です。
Poetryで管理しているため、以下で依存関係をインストールします。
```shell
poetry install
```

## 利用方法

### ログ取得
現在の実装ではscheduleを利用してログを記録します。
ロガーの設定のため、以下のように`config.json`に記録開始・終了時間を記述します。
```json
{
    "start_time": "09:30",
    "end_time": "23:30"
}
```
以下でロガーを実行して、マシンを常に起動した状態にします。
ブラウザでe-amusementにログインした後、開発者ツールなどからセッションに関わるCookie(key=value)をコピーして入力します。
```shell
python logger.py
```
データを構築するまでには数日間ログを取る必要があり、曜日の統計に至っては数週間必要なため根気が必要です。

### 簡易的なデータ取得
matplotlib+FastAPIで簡易的にデータやグラフを取得する場合は以下のようにサーバーを動かします。
```shell
uvicorn fastapi_main:app --reload
```
各エンドポイントはSwagger UIで自動生成されたドキュメント`localhost:8000/docs`で確認できます。

#### 使用例：水曜日の平均プレイ人数推移のグラフ
![weekday-average-demo](https://user-images.githubusercontent.com/55864383/211237609-2f2f7789-8713-418c-9a2b-f9e0651341b7.png)

### インタラクティブなグラフの利用
上のデモGIFのようにDashでインタラクティブなグラフを利用する場合は以下のように実行します。
```shell
python dash_main.py
```
`localhost:8050/`で動作を確認します。

### Test
テストはこのディレクトリで以下のように実行。
```shell
python -m pytest test
```

## limitation

### プレイ時間推定は確実ではない
原理上、ライバル検索画面に変化が起きない場合はプレイ時間を推定できません。
この状況は一人が長時間プレイする場合や、二人がほとんど同じタイミングでプレイを終えるときなどに発生します。
この場合は、最後にプレイを確認した時間から閾値時間だけプレイ判定にしています。
そのため、プレイ人数推定値が1から0に変化する箇所は不正確な可能性が高いです。
一人以下を空いていると考える場合は、空いている時間を探す目的では問題になりません。

### 店舗の情勢によっては役に立たない
1台しかない店舗では効果が薄いです。
また、台数が多い店舗では動作を確認していません。
人口が多い店舗ではそもそも空いている時間がない可能性もあります。
プレイ人数が曜日や時間帯で大きく異なっている場合には有効です。
